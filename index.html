<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ðŸ“š Excel-Quiz</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; background: #f4f4f4; margin: 0; padding: 1em; }
    .container { max-width: 800px; margin: auto; background: #fff; padding: 2em; border-radius: 16px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1, h2 { text-align: center; }
    select, button, input[type=file] { width: 100%; padding: 0.5em; margin-top: 1em; font-size: 1em; }
    .question-block { margin-top: 2em; }
    .answers label { display: block; text-align: left; margin-bottom: 0.5em; background: #eee; padding: 0.5em; border-radius: 8px; cursor: pointer; }
    .nav-buttons { margin-top: 1em; display: flex; justify-content: space-between; }
    #statsChart { margin-top: 3em; }
    .note, .fachstatus { font-size: 0.9em; color: #666; margin-top: 0.5em; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ“š Excel-Quiz</h1>
    <input type="file" id="file" accept=".xlsx" />
    <select id="fachSelect"><option value="">Fach wÃ¤hlen...</option></select>
    <div class="fachstatus" id="fachStatus"></div>
    <div id="quiz"></div>
    <div class="nav-buttons">
      <button onclick="prevQuestion()">ZurÃ¼ck</button>
      <button onclick="nextQuestion()">Weiter</button>
    </div>
	<div class="note">Hinweis: Mehrfachauswahl mÃ¶glich.</div>
    <canvas id="statsChart"></canvas>
  </div>
  <script>
    let fullData = [];
    let selectedFach = '';
    let questions = [];
    let current = 0;
    let stats = JSON.parse(localStorage.getItem("quizStats") || "{}");
    let completedFaecher = JSON.parse(localStorage.getItem("completedFaecher") || "[]");

    document.getElementById('file').addEventListener('change', function(e) {
      const reader = new FileReader();
      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        fullData = XLSX.utils.sheet_to_json(sheet);
        updateFachauswahl();
      };
      reader.readAsArrayBuffer(e.target.files[0]);
    });

    function updateFachauswahl() {
      const faecher = [...new Set(fullData.map(q => q.Fach))];
      const sel = document.getElementById("fachSelect");
      const statusBox = document.getElementById("fachStatus");
      sel.innerHTML = '<option value="">Fach wÃ¤hlen...</option>' +
        faecher.map(f => `<option value="${f}" ${completedFaecher.includes(f) ? 'disabled' : ''}>${f}${completedFaecher.includes(f) ? ' (âœ… erledigt)' : ''}</option>`).join("");
      statusBox.innerHTML = "<strong>FÃ¤cherstatus:</strong><br>" +
        faecher.map(f => `${completedFaecher.includes(f) ? 'âœ…' : 'ðŸ”“'} ${f}`).join("<br>");
      if (completedFaecher.length === faecher.length) {
        completedFaecher = [];
        localStorage.setItem("completedFaecher", JSON.stringify(completedFaecher));
        alert("ðŸŽ‰ Alle FÃ¤cher wurden bearbeitet. Ein neuer Durchgang beginnt!");
        updateFachauswahl();
      }
    }

    document.getElementById("fachSelect").addEventListener("change", function() {
      selectedFach = this.value;
      if (!selectedFach) return;
      const fachFragen = fullData.filter(q => q.Fach === selectedFach);
      questions = shuffleArray(fachFragen).slice(0, 12);
      current = 0;
      showQuestion();
    });

    function formatText(text) {
      if (!text) return "";
      return text.replaceAll("\n", "<br>")
                 .replaceAll("(1)", "<br>1.")
                 .replaceAll("(2)", "<br>2.")
                 .replaceAll("(3)", "<br>3.")
                 .replaceAll("(4)", "<br>4.")
                 .replaceAll("(.)", "<br>&bull;");
    }

    function showQuestion() {
      const q = questions[current];
      const answers = Object.keys(q)
        .filter(k => k.startsWith("Richtige Antwort") || k.startsWith("Falsche Antwort"))
        .map(k => ({ text: q[k], correct: k.startsWith("Richtige") }))
        .filter(a => a.text && a.text.trim() !== "");
      const shuffled = shuffleArray(answers);
      const container = document.getElementById("quiz");
      container.innerHTML = `<div class="question-block">
        <h2>Frage ${current + 1}/12</h2>
        <p>${formatText(q.Frage)}</p>
        <form class="answers">
          ${shuffled.map((a, i) => `<label><input type="checkbox" name="answer" value="${a.correct}"> ${formatText(a.text)}</label>`).join("")}
        </form>
        <button onclick="checkAnswer()">Antwort prÃ¼fen</button>
      </div>`;
    }

    function checkAnswer() {
      const inputs = document.querySelectorAll('input[name="answer"]');
      const correct = Array.from(inputs).every(input => input.checked == (input.value === "true"));
      const f = selectedFach;
      if (!stats[f]) stats[f] = { richtig: 0, falsch: 0 };
      correct ? stats[f].richtig++ : stats[f].falsch++;
      localStorage.setItem("quizStats", JSON.stringify(stats));
      nextQuestion();
    }

    function nextQuestion() {
      if (current < questions.length - 1) {
        current++;
        showQuestion();
      } else {
        drawChart();
        if (!completedFaecher.includes(selectedFach)) {
          completedFaecher.push(selectedFach);
          localStorage.setItem("completedFaecher", JSON.stringify(completedFaecher));
        }
        updateFachauswahl();
        document.getElementById("quiz").innerHTML = `<h2>Fach abgeschlossen!</h2><p>WÃ¤hle ein neues Fach aus der Liste.</p>`;
      }
    }

    function prevQuestion() {
      if (current > 0) {
        current--;
        showQuestion();
      }
    }

    function shuffleArray(arr) {
      return arr.map(v => [Math.random(), v]).sort().map(a => a[1]);
    }

    function drawChart() {
      const ctx = document.getElementById("statsChart").getContext("2d");
      const labels = Object.keys(stats);
      const correct = labels.map(f => stats[f].richtig);
      const wrong = labels.map(f => stats[f].falsch);
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Richtig', data: correct, backgroundColor: 'green' },
            { label: 'Falsch', data: wrong, backgroundColor: 'red' }
          ]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } },
          plugins: { title: { display: true, text: 'Lernerfolg nach Fach' } }
        }
      });
    }
  </script>
</body>
</html>
